name: Build Application

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-swift-macos:
    name: Build Swift macOS App (Universal)
    runs-on: macos-15-intel
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Display Swift version
      run: swift --version
      
    - name: Display architecture
      run: |
        echo "Runner architecture: $(uname -m)"
        echo "Available architectures for compilation: x86_64, arm64"
        
    - name: Build Universal Binary (x86_64 + arm64)
      run: |
        echo "Building for Intel (x86_64)..."
        swift build -c release --arch x86_64
        
        echo "Building for Apple Silicon (arm64)..."
        swift build -c release --arch arm64
        
        echo "Creating Universal Binary..."
        mkdir -p .build/universal
        lipo -create \
          .build/arm64-apple-macosx/release/PowninAssistant \
          .build/x86_64-apple-macosx/release/PowninAssistant \
          -output .build/universal/PowninAssistant
        
        echo "Verifying Universal Binary..."
        lipo -info .build/universal/PowninAssistant
      
    - name: Run tests
      run: |
        if [ -d "Tests" ]; then
          swift test
        else
          echo "No Tests directory found, skipping tests"
        fi
      continue-on-error: true
      
    - name: Archive Universal build
      uses: actions/upload-artifact@v4
      with:
        name: PowninAssistant-macOS-Universal
        path: .build/universal/
        if-no-files-found: warn

  build-electron:
    name: Build Electron App
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15-intel, ubuntu-latest, windows-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      working-directory: electron-app
      run: npm install

    - name: Install icon generation tools (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install librsvg
        fi
      shell: bash

    - name: Install icon generation tools (Windows)
      if: runner.os == 'Windows'
      run: choco install imagemagick -y
      shell: powershell

    - name: Generate PNG icons from SVG (Linux/macOS)
      if: runner.os != 'Windows'
      working-directory: electron-app
      run: |
        mkdir -p assets/icons
        for size in 16 32 48 64 128 256 512 1024; do
          rsvg-convert -w $size -h $size assets/icon.svg -o assets/icons/icon-${size}.png
          echo "Generated ${size}x${size} icon"
        done
        echo "Generated icons:"
        ls -la assets/icons/
      shell: bash

    - name: Generate PNG icons from SVG (Windows)
      if: runner.os == 'Windows'
      working-directory: electron-app
      run: |
        New-Item -ItemType Directory -Force -Path assets/icons
        $sizes = @(16, 32, 48, 64, 128, 256, 512, 1024)
        foreach ($size in $sizes) {
          magick convert -background none -resize "${size}x${size}" assets/icon.svg "assets/icons/icon-${size}.png"
          Write-Host "Generated ${size}x${size} icon"
        }
        Get-ChildItem assets/icons/
      shell: powershell
      
    - name: Build Electron app
      working-directory: electron-app
      run: npm run build
      
    - name: Package application
      working-directory: electron-app
      run: |
        if [ "$RUNNER_OS" == "macOS" ]; then
          npx electron-builder --mac --x64 --arm64
        else
          npm run package
        fi
      shell: bash
      continue-on-error: true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Archive Electron build
      uses: actions/upload-artifact@v4
      with:
        name: PowninAssistant-Electron-${{ matrix.os }}
        path: electron-app/dist/
        if-no-files-found: warn

  verify-integration:
    name: Verify AI Integration
    runs-on: macos-15-intel
    needs: build-swift-macos
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify AI Service files
      run: |
        echo "Checking AI Service implementation..."
        for file in AIService AIModelProvider OpenAIProvider AnthropicProvider; do
          if [ -f "PowninAssistant/Services/${file}.swift" ]; then
            echo "✓ ${file}.swift found"
          else
            echo "✗ ${file}.swift not found"
            exit 1
          fi
        done
